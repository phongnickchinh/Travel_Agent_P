root@55243:/home/travel_project/server# docker exec -it travel-agent-flask head -n 80 /docker-entrypoint.sh
#!/bin/bash
# ========================================
# Docker Entrypoint Script
# Runs database migrations before starting app
# Also handles database backup/restore
# ========================================

set -e

echo "========================================"
echo "Travel Agent P - Starting Application"
echo "========================================"

# Normalize DB name for all operations (honor both POSTGRES_DBNAME and POSTGRES_DB)
DB_NAME="${POSTGRES_DBNAME:-${POSTGRES_DB:-railway}}"

# ============= Database Backup Function =============
backup_database() {
    echo "ðŸ“¦ Creating database backup..."
    BACKUP_DIR="/backups"
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    BACKUP_FILE="$BACKUP_DIR/backup_$TIMESTAMP.sql"
    
    mkdir -p "$BACKUP_DIR"
    PGPASSWORD=$POSTGRES_PASSWORD pg_dump -h "$POSTGRES_HOST" -U "$POSTGRES_USERNAME" -d "$DB_NAME" -F c -b > "$BACKUP_FILE" 2>/dev/null || {
        echo "âš ï¸  Backup failed or database '$DB_NAME' not exists yet"
        return 0
    }
    
    echo "âœ… Backup created: $BACKUP_FILE"
    
    # Keep only last 5 backups
    ls -t "$BACKUP_DIR"/backup_*.sql 2>/dev/null | tail -n +6 | xargs -r rm 2>/dev/null || true
}

# ============= Database Restore Function =============
restore_database() {
    BACKUP_FILE="/backups/phong.sql"
    
    if [ ! -f "$BACKUP_FILE" ]; then
        echo "âš ï¸  No backup file found at $BACKUP_FILE (skip restore)"
        return 0
    fi
    
    echo "ðŸ“¦ Found backup file, checking if restore needed..."
    
    # Check if target database exists and has tables
    TABLE_COUNT=$(PGPASSWORD=$POSTGRES_PASSWORD psql -h "$POSTGRES_HOST" -U "$POSTGRES_USERNAME" -d "$DB_NAME" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public'" 2>/dev/null || echo "0")
    TABLE_COUNT=$(echo "$TABLE_COUNT" | tr -d '[:space:]')
    
    if [ "$TABLE_COUNT" -gt "0" ]; then
        echo "âœ… Database already has $TABLE_COUNT tables (skip restore)"
        return 0
    fi
    
    echo "ðŸ”„ Restoring database from backup..."
    
    # Create database if not exists
    PGPASSWORD=$POSTGRES_PASSWORD psql -h "$POSTGRES_HOST" -U "$POSTGRES_USERNAME" -d postgres -c "CREATE DATABASE \"$DB_NAME\";" 2>/dev/null || true
    
    # Restore from backup
    PGPASSWORD=$POSTGRES_PASSWORD pg_restore -h "$POSTGRES_HOST" -U "$POSTGRES_USERNAME" -d "$DB_NAME" -v --no-owner --no-privileges "$BACKUP_FILE" 2>&1 || {
        echo "âš ï¸  pg_restore completed with warnings (normal for existing objects)"
    }
    
    echo "âœ… Database restore completed!"
}

# Wait for PostgreSQL to be ready
echo "Waiting for PostgreSQL..."
until PGPASSWORD=$POSTGRES_PASSWORD psql -h "$POSTGRES_HOST" -U "$POSTGRES_USERNAME" -d postgres -c '\q' 2>/dev/null; do
    echo "PostgreSQL is unavailable - sleeping"
    sleep 2
done
echo "âœ… PostgreSQL is ready!"

# Auto-restore database if needed (only on fresh deployment)
restore_database

# Wait for MongoDB to be ready